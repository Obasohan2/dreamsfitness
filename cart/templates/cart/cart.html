{% extends "base.html" %}
{% load static %}
{% block page_header %}
<div class="container header-container">
    <div class="row">
        <div class="col text-center"></div>
    </div>
</div>
{% endblock %}
{% block content %}
<div class="overlay"></div>

<div class="container mt-5 mb-5">
  <h2 class="mb-4 text-center">Your Shopping Cart</h2>

  {% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if cart_count == 0 and not subscription %}
    <!-- Empty Cart Display -->
    <div class="text-center my-5">
      <i class="fa-solid fa-cart-shopping text-muted mb-3" style="font-size: 5rem;"></i>
      <h5>Your cart is empty!</h5>
      <a href="{% url 'products:all_products' %}" class="btn btn-primary mt-3">Browse Products</a>
    </div>

  {% else %}
  
  {% if cart_count > 0 %}
  <!-- Product List -->
  <h4 class="mt-4 mb-3">Products</h4>
  <div class="table-responsive mb-4">
    <table class="table table-bordered table-hover text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Product</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <tr>
          <td class="text-start">
            <strong>{{ item.product.name }}</strong><br>
            <small class="text-muted">{{ item.product.description|truncatechars:80 }}</small>
          </td>
          <td>
            <form action="{% url 'cart:update_cart' item.product.id %}" method="post" class="d-inline update-cart-form">
              {% csrf_token %}
              <input type="number" name="quantity" value="{{ item.quantity }}" min="1"
                     class="form-control form-control-sm d-inline-block w-auto text-center" aria-label="Quantity">
              <button type="submit" class="btn btn-sm btn-outline-primary mt-1" title="Update product quantity">
                Update
              </button>
            </form>
          </td>
          <td>${{ item.price|floatformat:2 }}</td>
          <td>${{ item.total_price|floatformat:2 }}</td>
          <td>
            <a href="#" 
               class="btn btn-sm btn-outline-danger remove-btn"
               data-url="{% url 'cart:remove_from_cart' item.product.id %}">
              Remove
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- Available Subscriptions -->
  {% if subscriptions %}
  <h4 class="mt-4 mb-3">Available Subscriptions</h4>
  {% for plan in subscriptions %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <h5 class="mb-1">{{ plan.title }}</h5>
        <p class="mb-0">Price: <strong>${{ plan.price|floatformat:2 }}</strong></p>
      </div>
      <a href="{% url 'cart:add_subscription_to_cart' plan.id %}" 
         class="btn btn-outline-success btn-sm mt-2 mt-sm-0">
        Add to Cart
      </a>
    </div>
  </div>
  {% endfor %}
  {% endif %}

  <!-- Active Subscription -->
  {% if subscription %}
  <h4 class="mt-4 mb-3">Your Selected Subscription</h4>
  <div class="card mb-3 shadow-sm">
    <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <h5 class="mb-1">{{ subscription.title }}</h5>
        <p class="mb-0">Price: <strong>${{ subscription.price|floatformat:2 }}</strong></p>
      </div>
      <a href="#" 
         class="btn btn-outline-danger btn-sm mt-2 mt-sm-0 remove-sub-btn"
         data-url="{% url 'cart:remove_subscription_from_cart' %}">
        Remove Subscription
      </a>
    </div>
  </div>
  {% endif %}

  <!-- Total and Checkout -->
  <div class="d-flex justify-content-between align-items-center mt-4 border-top pt-3">
    <h4 class="mb-0">Total:</h4>
    <h4 class="text-primary mb-0">${{ total_price|floatformat:2 }}</h4>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-4">
    <div>
      <a href="{% url 'products:all_products' %}" class="btn btn-outline-success">
        <i class="fas fa-arrow-left me-2"></i> Continue Shopping
      </a>
    </div>
    <div>
      <a href="#" 
         class="btn btn-outline-secondary me-2 clear-cart-btn"
         data-url="{% url 'cart:clear_cart' %}">
        Clear Cart
      </a>
      {% if request.user.is_authenticated %}
  <a href="{% url 'cart:checkout' %}" class="btn btn-primary">
    Proceed to Checkout <i class="fas fa-arrow-right ms-2"></i>
  </a>
{% else %}
  <a href="{% url 'account_login' %}?next={% url 'cart:checkout' %}" class="btn btn-primary">
    Login to Checkout <i class="fas fa-sign-in-alt ms-2"></i>
  </a>
{% endif %}      
    </div>
  </div>
  {% endif %}
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmMessage">Are you sure?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a href="#" id="confirmActionBtn" class="btn btn-danger">Yes, Continue</a>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
  const confirmBtn = document.getElementById('confirmActionBtn');
  const confirmMessage = document.getElementById('confirmMessage');

  function handleConfirm(button, message) {
    button.addEventListener('click', e => {
      e.preventDefault();
      confirmMessage.textContent = message;
      confirmBtn.href = button.getAttribute('data-url');
      modal.show();
    });
  }

  document.querySelectorAll('.remove-btn').forEach(btn =>
    handleConfirm(btn, "Remove this item from your cart?")
  );

  document.querySelectorAll('.remove-sub-btn').forEach(btn =>
    handleConfirm(btn, "Remove your subscription from the cart?")
  );

  document.querySelectorAll('.clear-cart-btn').forEach(btn =>
    handleConfirm(btn, "Are you sure you want to clear your entire cart?")
  );
});
</script>

{% endblock %}
